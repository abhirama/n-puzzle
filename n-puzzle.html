<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

		<style type="text/css">
			table { 
				margin-left: auto;
				margin-right: auto;
				text-align: center;
			}

			.cell {
				background-color: red;
				cursor: pointer;
			}
		</style>

		<script type="text/JavaScript" src="jquery-1.4.3.js"></script> 
		<script type="text/javascript">
			$(document).ready(function(){
				var INITIAL_ROWS = 2;
				var INITIAL_COLUMNS = 2;

				//global variable to hold the current empty cell row and column
				var _emptyCellRow = INITIAL_ROWS - 1;
				var _emptyCellColumn = INITIAL_COLUMNS - 1;

				//to hold the no of moves the user takes to complete the puzzle
				var _moveCounter = 0;

				function createTable(rows, columns) {
					//using dom appending to create the table as it is more readable than string munging. 
					//Not the most efficient way but for a small app like this it does not matter.
					//takes care of the cases where the player resets the board
					$('#mainContainer table').remove();
					$('#mainContainer').append('<table border="1" cell-padding="1" cell-spacing="1" id="board"></table>');
					for (var row = 0; row < rows; ++row) {
						$('#board').append('<tr></tr>');
						for (var column = 0; column < columns; ++column) {
							var id = getCellId(row, column);
							$('#board tr:last').append('<td id=' + id + '></td>');
							$('#' + id).data("row", row);
							$('#' + id).data("column", column);
						}
					}

					//the last values of rows and columns are the empty cell row and column values
					_emptyCellRow = row - 1;
					_emptyCellColumn = column - 1;
				}

				function getCellId(row, column) {
					return 'cell' + row + '' + column;
				}

				function getNumberArray(rows, columns) {
					//generate an array that holds all the number applicable for the board
					var totalCount = rows * columns;
					var numbers = [];
					for (var no = 1; no < totalCount; ++no) {
						numbers.push(no);		
					}
					return numbers;
				}

				//using Fisher Yates algorithm
				function shuffleNumberArray(numbers) {
					var totalCount = numbers.length;
					for (var index = 0; index < totalCount; ++index) {
						var shuffleIndex = Math.floor(Math.random() * (totalCount - 1));
						swap(index, shuffleIndex, numbers);
					}
				}

				function swap(firstIndex, secondIndex, arrayy) {
					var temp = arrayy[firstIndex];
					arrayy[firstIndex] = arrayy[secondIndex];
					arrayy[secondIndex] = temp;
				}

				function assignNumbersToBoard(numbers) {
					var index = 0;
					$('#board td').each(function(){
						if (index == numbers.length) {
							return;
						}

						$(this).text(numbers[index]);
						$(this).addClass('cell');
						index = index + 1;
					});
				}

				function isEmptyCell(row, column) {
					return row == _emptyCellRow && column == _emptyCellColumn;
				}

				function isValidClick(cell) {
					var row = cell.data('row');
					var column = cell.data('column');

					//blindly check the four cells bounding this cell for empty space. If found, valid click. Else invalid

					//check to left
					var leftColumn = column - 1;
					if (isEmptyCell(row, leftColumn)) {
						return true;
					}

					//check right
					var rightColumn = column + 1;
					if (isEmptyCell(row, rightColumn)) {
						return true;
					}

					//check top
					var topRow = row - 1;
					if (isEmptyCell(topRow, column)) {
						return true;
					}

					//check below 
					var belowRow = row + 1;
					if (isEmptyCell(belowRow, column)) {
						return true;
					}

					return false;
				}

				//http://stackoverflow.com/questions/698301/is-there-a-native-jquery-function-to-switch-elements
				function swapNodes(a, b) {
					swapIds(a, b);
					swapDataElements(a, b);
					var aParent= a.parentNode;
					var aSibling= a.nextSibling === b ? a : a.nextSibling;
					b.parentNode.insertBefore(a, b);
					aParent.insertBefore(b, aSibling);
				}

				function swapIds(nodeA, nodeB) {
					var aId = nodeA.id;
					var bId = nodeB.id;

					nodeA.id = bId;
					nodeB.id = aId;
				}

				function swapDataElements(nodeA, nodeB) {
					var jQueryNodeA = $(nodeA);
					var jQueryNodeB = $(nodeB);

					var aDataRow = jQueryNodeA.data('row');
					var aDataColumn = jQueryNodeA.data('column');

					var bDataRow = jQueryNodeB.data('row');
					var bDataColumn = jQueryNodeB.data('column');

					jQueryNodeA.data('row', bDataRow);
					jQueryNodeA.data('column', bDataColumn);

					jQueryNodeB.data('row', aDataRow);
					jQueryNodeB.data('column', aDataColumn);
				}

				function isPuzzleSolved() {
					var cells = (INITIAL_ROWS * INITIAL_COLUMNS) - 1;
					var solved = true;
					$('td').each(function(index){
						if (index < cells && $(this).text() != (index + 1)) {
							solved = false;
							return false;
						}
						solved = true;
					});
					return solved;
				}

				function validateInputBoardValues(rows, columns) {
					if (rows == 'undefined' || rows == '') {
						alert('Please provide valid value for rows');
						return false;
					}

					if (columns == 'undefined' || columns == '') {
						alert('Please provide valid value for columns');
						return false;
					}

					if (rows != columns) {
						alert('Rows and columns have to match');
						return false;
					}

					return true;
				}

				//inline - begin
				createTable(INITIAL_ROWS, INITIAL_COLUMNS);
				//var numbers = getNumberArray(INITIAL_ROWS, INITIAL_COLUMNS);
				//shuffleNumberArray(numbers);
				assignNumbersToBoard([3, 1, 2]);

				//events bindings - start
				$('.cell').bind('click', function(){
					if (isValidClick($(this))) {
						var emptyCellId = getCellId(_emptyCellRow, _emptyCellColumn);
						var emptyCell = document.getElementById(emptyCellId);

						//assign empty cell row and column to the currently clicked cell
						//do not move this piece of code as this has to be done before the nodes are swapped
						_emptyCellRow = $(this).data('row');
						_emptyCellColumn = $(this).data('column');

						swapNodes(emptyCell, this);

						_moveCounter = _moveCounter + 1;
						$('#moveCount').text(_moveCounter);

						if (isPuzzleSolved()) {
							alert('You just solved the puzzle');
						}
					} else {
						alert('Invalid click');
					}
				});

				$('#newGameButton').bind('click', function(){
					var inputBoardRows = $('#boardRows').val();
					var inputBoardColumns = $('#boardColumns').val();
					if (validateInputBoardValues(inputBoardRows, inputBoardColumns)) {
						INITIAL_ROWS = parseInt(inputBoardRows);
						INITIAL_COLUMNS = parseInt(inputBoardColumns);

						createTable(INITIAL_ROWS, INITIAL_COLUMNS);
						var numbers = getNumberArray(INITIAL_ROWS, INITIAL_COLUMNS);
						shuffleNumberArray(numbers);
						assignNumbersToBoard(numbers);

						_moveCounter = 0;
					}
				});
				//events bindings - end
				//inline - end 
			});
		</script>
	</head>
	<body>
		<div id="mainContainer">
		</div>
		<p><input type='text' value='3' id='boardRows'/>X<input type='text' value='3' id='boardColumns'/>
			<input type='button' value='New Game' id='newGameButton'/>
		</p>
		<p>Moves:<div id="moveCount">0</div></p>
	</body>
</html>

